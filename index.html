<!DOCTYPE html>
<html>
	<head>
		<title>What's SQL?</title>
		
		<!-- Firebase -->
		<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
		<script>
			firebase.initializeApp({
				apiKey: "AIzaSyDnYWX-r6-fr9LvXRhrj3dNBFa3_qVZ5DU",
				authDomain: "whats-sql.firebaseapp.com",
				databaseURL: "https://whats-sql.firebaseio.com",
				projectId: "whats-sql",
				storageBucket: "whats-sql.appspot.com",
				messagingSenderId: "1037753971448"
			});
		</script>
		<script src="https://apis.google.com/js/platform.js" async defer></script>
		
		<!-- jQuery -->
		<script src="https://code.jquery.com/jquery-latest.min.js"></script>
		
		<script>
			function generateUUID() { 
				var d = new Date().getTime();
				if (typeof performance !== 'undefined' && typeof performance.now === 'function'){
					d += performance.now();
				}
				return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
					var r = (d + Math.random() * 16) % 16 | 0;
					d = Math.floor(d / 16);
					return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
				});
			}
			
			function listen(path, eventType, callback) {
				firebase.database().ref(path).on(eventType, callback);
				return {path, eventType, callback};
			}
			function read(path, eventType, callback) {
				return firebase.database().ref(path).once(eventType, callback);
			}
			function write(path, value, onComplete) {
				return firebase.database().ref(path).set(value, onComplete);
			}
			function detach(path, eventType, callback) {
				return firebase.database().ref(path).off(eventType, callback);
			}
			function remove(path) {
				return firebase.database().ref(path).remove();
			}
			
			function listenElemText(path, elem) {
				return listen(path, "value", function (dataSnapshot) {
					elem.text(dataSnapshot.val());
				});
			}
			function listenElemDisplay(path, elem, inverse) {
				return listen(path, "value", function (dataSnapshot) {
					elem.toggle(inverse ? !dataSnapshot.exists() : dataSnapshot.exists());
				});
			}
		</script>
		
		<style>
			* {
				box-sizing: border-box;
			}
			body {
				width: 550px;
				
				margin: auto;
			}
			.group {
				border: 1px solid black;
				
				padding: 5px;
			}
			.list {
				border: 1px solid black;
				
				padding: 5px;
				
				max-height: 100px;
				overflow-y: auto;
			}
			.chat-title {
				color: blue;
				
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<!-- Login screen -->
		<div id="login-screen" style="display: none">
			<input id="google-button" type="button" value="Login Google"/>
			<input id="facebook-button" type="button" value="Login Facebook"/>
		</div>
		
		<!-- Chat screen -->
		<div id="chat-screen" style="display: none">
			<!-- Logout button -->
			<input id="logout-button" type="button" value="Logout"/>
			
			<!-- Username -->
			<div class="group">
				<div>
					<b>Username:</b> <span id="username"></span>
					<input id="change-username" type="button" value="Change username"/>
				</div>
				<div>
					<b>E-mail:</b> <span id="email"></span>
				</div>
			</div>
			
			<!-- Contacts -->
			<div class="group">
				<div>
					<b>Contacts:</b>
					<input id="add-contact" type="button" value="Add contact"/>
				</div>
				<div id="contacts" class="list">
				</div>
			</div>
			
			<!-- Chats -->
			<div class="group">
				<div>
					<b>Chats:</b>
					<input id="create-chat" type="button" value="Create chat"/>
				</div>
				<div id="chats" class="list">
				</div>
			</div>
			
			<!-- Chat -->
			<div id="chat" class="group" style="display: none">
				<div>
					<b>Chat:</b>
					<span id="chat-title"></span>
					<input id="change-title" type="button" value="Change title"/>
					<input id="close-chat" type="button" value="Close chat"/>
				</div>
				
				<!-- Members -->
				<div class="group">
					<b>Members:</b>
					<div id="members" class="list">
					</div>
				</div>
				
				<!-- Messages -->
				<div class="group">
					<div>
						<b>Messages:</b>
						<input id="load-more" type="button" value="Load more"/>
					</div>
					<div id="messages" class="list">
					</div>
				</div>
				
				<!-- Message -->
				<div class="group">
					<b>Message:</b>
					<div><input id="message" type="text" style="width: 100%"/></div>
				</div>
			</div>
		</div>
		
		<script>
			$(document).ready(function () {
				function detachChatListeners() {
					for (let chatListener of chatListeners)
						detach(chatListener.path, chatListener.eventType, chatListener.callback);
					chatListeners.length = 0;
				}
				function closeChat() {
					detachChatListeners();
					
					$("#chat").hide();
				}
				function removeChatMember(chatId, memberId) {
					remove("user_chats/" + memberId + "/" + chatId);
					
					remove("chat_members/" + chatId + "/" + memberId);
					remove("chat_admins/" + chatId + "/" + memberId);
				}
				function scrollToTop() {
					$("#messages").stop().animate({scrollTop: 0}, 800);
				}
				function scrollToBottom() {
					$("#messages").stop().animate({scrollTop: $("#messages")[0].scrollHeight}, 800);
				}
				function loadMoreMessages(scrollDown) {
					$("#load-more").prop("disabled", true);
					
					const totalMessages = 5;
					let numMessages = 0;
					
					let lastMessageElem = null;
					
					let messageCallback = function (messageSnapshot) {
						let message = messageSnapshot.val();
						
						if (message.timestamp < endTimestamp)
							endTimestamp = message.timestamp - 1;
						
						let messageElem = null;
						if (!lastMessageElem)
							messageElem = $("<div></div>").prependTo("#messages");
						else
							messageElem = $("<div></div>").insertAfter(lastMessageElem);
						
						chatListeners.push(listen("user_names/" + message.author, "value", function (authorSnapshot) {
							messageElem.text(message.timestamp + " - " + authorSnapshot.val() + ": " + message.content);
						}));
						
						if (scrollDown)
							scrollToBottom();
						else
							scrollToTop();
						
						if (++numMessages === totalMessages)
							$("#load-more").prop("disabled", false);
						
						lastMessageElem = messageElem;
					};
					firebase.database().ref("chat_messages/" + chatId).orderByChild("timestamp").endAt(endTimestamp).limitToLast(totalMessages).on("child_added", messageCallback);
					chatListeners.push({path: "chat_messages/" + chatId, eventType: "child_added", callback: messageCallback});
				}
				
				// Login screen
				$("#google-button").click(function () {
					let provider = new firebase.auth.GoogleAuthProvider();
					provider.setCustomParameters({prompt: "select_account"});
					firebase.auth().signInWithPopup(provider);
				});
				$("#facebook-button").click(function () {
					let provider = new firebase.auth.FacebookAuthProvider();
					firebase.auth().signInWithPopup(provider);
				});
				$("#logout-button").click(function () {
					firebase.auth().signOut();
				});
				
				// Chat screen
				$("#change-username").on("click", function () {
					let newUsername = prompt("New username:", "");
					if (!newUsername)
						return;
					
					write("user_names/" + firebase.auth().currentUser.uid, newUsername);
				});
				$("#add-contact").on("click", function () {
					let contactEmail = prompt("Contact e-mail:", "");
					if (!contactEmail)
						return;
						
					if (contactEmail === firebase.auth().currentUser.email)
						return alert("Can't add yourself.");
					
					firebase.database().ref("user_emails").orderByValue().
					equalTo(contactEmail).once("value", function (contactSnapshot) {
						if (!contactSnapshot.exists())
							return alert("User not found.");
							
						for (let contactId in contactSnapshot.val())
							write("user_contacts/" + firebase.auth().currentUser.uid + "/" + contactId, true);
					});
				});
				$("#create-chat").on("click", function () {
					let chatTitle = prompt("Chat title:", "");
					if (!chatTitle)
						return;
						
					let chatId = generateUUID();
					
					write("chat_titles/" + chatId, chatTitle);
					write("chat_members/" + chatId + "/" + firebase.auth().currentUser.uid, true);
					write("chat_admins/" + chatId + "/" + firebase.auth().currentUser.uid, true);
					
					write("user_chats/" + firebase.auth().currentUser.uid + "/" + chatId, true);
				});
				$("#change-title").on("click", function () {
					let newTitle = prompt("New title:", "");
					if (!newTitle)
						return;
					
					write("chat_titles/" + chatId, newTitle);
				});
				$("#close-chat").on("click", function () {
					closeChat();
				});
				$("#load-more").on("click", function () {
					loadMoreMessages();
				});
				$("#message").on("keydown", function () {
					if (event.keyCode !== 13)
						return;
					
					write("chat_messages/" + chatId + "/" + generateUUID(), {
						timestamp: firebase.database.ServerValue.TIMESTAMP,
						author: firebase.auth().currentUser.uid,
						content: $("#message").val()
					});
					
					$("#message").val("");
				});
				
				function verifyAccount(user) {
					read("user_names/" + user.uid, "value", function (userSnapshot) {
						if (userSnapshot.exists()) {
							// Other logins
							onLogin(user);
						} else {
							// First login
							Promise.all([
								write("user_names/" + user.uid, user.displayName),
								write("user_emails/" + user.uid, user.email)
							]).then(function () {
								onLogin(user);
							});
						}
					});
				}
				
				appListeners = [];
				chatListeners = [];
				
				function onLogin(user) {
					// Listen username
   					appListeners.push(listen("user_names/" + user.uid, "value", function (dataSnapshot) {
   					   $("#username").text(dataSnapshot.val());
				   	}));
					
					// Read e-mail
					$("#email").text(user.email);
					
					// Listen contacts
					let contacts = {};
					$("#contacts").html("");
					appListeners.push(listen("user_contacts/" + user.uid, "child_added", function (contactSnapshot) {
						contacts[contactSnapshot.key] = {};
					
						let contactElem = $("<div></div>").appendTo("#contacts");
						contacts[contactSnapshot.key].elem = contactElem;
						
						// Contact name
						let contactNameElem = $("<span></span>").appendTo(contactElem);
						appListeners.push(listenElemText("user_names/" + contactSnapshot.key, contactNameElem));
						
						contactElem.append(" ");
						
						// Add member button
						let addMemberButton = $("<input type='button'/>").appendTo(contactElem);
						addMemberButton.val("Add to chat").hide();
						contacts[contactSnapshot.key].addMemberButton = addMemberButton;
						
						contactElem.append(" ");
						
						// Remove button
						let removeButton = $("<input type='button' value='Remove contact'/>").appendTo(contactElem);
						removeButton.on("click", function () {
							remove("user_contacts/" + user.uid + "/" + contactSnapshot.key);
						});
					}));
					appListeners.push(listen("user_contacts/" + user.uid, "child_removed", function (contactSnapshot) {
						contacts[contactSnapshot.key].elem.remove();
						delete contacts[contactSnapshot.key].elem;
					}));
					
					// Listen chats
					let chatElems = {};
					$("#chats").html("");
					appListeners.push(listen("user_chats/" + user.uid, "child_added", function (chatSnapshot) {
						let chatElem = $("<div></div>").appendTo("#chats");
						chatElems[chatSnapshot.key] = chatElem;
						
						// Chat title
						let chatTitleElem = $("<span class='chat-title'></span>").appendTo(chatElem);
						appListeners.push(listenElemText("chat_titles/" + chatSnapshot.key, chatTitleElem));
						chatTitleElem.on("click", function () {
							chatId = chatSnapshot.key;
							selectChat();
						});
						
						chatElem.append(" ");
						
						// Remove button
						let removeButton = $("<input type='button' value='Remove chat'/>").appendTo(chatElem);
						removeButton.on("click", function () {
							removeChatMember(chatSnapshot.key, user.uid);
						});
					}));
					appListeners.push(listen("user_chats/" + user.uid, "child_removed", function (chatSnapshot) {
						chatElems[chatSnapshot.key].remove();
						delete chatElems[chatSnapshot.key];
					}));
					
					function selectChat() {
						$("#chat").show();
						
						// Listen membership
						chatListeners.push(listen("chat_members/" + chatId + "/" + user.uid, "value", function (membershipSnapshot) {
							if (!membershipSnapshot.exists())
								closeChat();
						}));
						
						// Listen title
						chatListeners.push(listenElemText("chat_titles/" + chatId, $("#chat-title")));
						
						// Listen admin
						chatListeners.push(listenElemDisplay("chat_admins/" + chatId + "/" + user.uid, $("#change-title")));
						chatListeners.push(listenElemDisplay("chat_admins/" + chatId + "/" + user.uid, $("#add-member")));
						
						// Listen contacts
						for (let contactId in contacts) {
							chatListeners.push(listenElemDisplay("chat_members/" + chatId + "/" + contactId, contacts[contactId].addMemberButton, true));
							
							contacts[contactId].addMemberButton.off().on("click", function () {
								write("user_chats/" + contactId + "/" + chatId, true);
								write("chat_members/" + chatId + "/" + contactId, true);
							});
						}
						
						// Listen members
						let memberElems = {};
						$("#members").html("");
						chatListeners.push(listen("chat_members/" + chatId, "child_added", function (memberSnapshot) {
							let memberElem = $("<div></div>").appendTo("#members");
							memberElems[memberSnapshot.key] = memberElem;
							
							// Member name
							let memberNameElem = $("<scan></scan>").appendTo(memberElem);
							chatListeners.push(listenElemText("user_names/" + memberSnapshot.key, memberNameElem));
							
							memberElem.append(" ");
							
							// Add contact button
							if (memberSnapshot.key !== user.uid) {
								let addContactButton = $("<input type='button' value='Add contact'/>").appendTo(memberElem);
								chatListeners.push(listenElemDisplay("user_contacts/" + user.uid + "/" + memberSnapshot.key, addContactButton, true));
								addContactButton.on("click", function () {
									write("user_contacts/" + user.uid + "/" + memberSnapshot.key, true);
								});
							}
							
							memberElem.append(" ");
							
							// Promote button
							let promoteButton = $("<input type='button' value='Promote'/>").appendTo(memberElem);
							chatListeners.push(listenElemDisplay("chat_admins/" + chatId + "/" + user.uid, promoteButton));
							chatListeners.push(listen("chat_admins/" + chatId + "/" + memberSnapshot.key, "value", function (adminSnapshot) {
								promoteButton.val(adminSnapshot.exists() ? "Demote" : "Promote");
							}));
							promoteButton.on("click", function () {
								let promote = $(this).val() === "Promote";
								if (promote)
									write("chat_admins/" + chatId + "/" + memberSnapshot.key, true);
								else
									remove("chat_admins/" + chatId + "/" + memberSnapshot.key);
							});
							
							memberElem.append(" ");
							
							// Remove button
							let removeButton = $("<input type='button' value='Remove member'/>").appendTo(memberElem);
							chatListeners.push(listenElemDisplay("chat_admins/" + chatId + "/" + user.uid, removeButton));
							removeButton.on("click", function () {
								removeChatMember(chatId, memberSnapshot.key);
							});
						}));
						chatListeners.push(listen("chat_members/" + chatId, "child_removed", function (memberSnapshot) {
							memberElems[memberSnapshot.key].remove();
							delete memberElems[memberSnapshot.key];
						}));
						
						// Listen messages
						$("#messages").html("");4
						read(".info/serverTimeOffset", "value", function (offsetSnapshot) {
							endTimestamp = new Date().getTime() + offsetSnapshot.val();
							
							// Old messages
							loadMoreMessages(true);
							
							// New messages
							let messageCallback = function (messageSnapshot) {
								let message = messageSnapshot.val();
								
								let messageElem = $("<div></div>").appendTo("#messages");
								chatListeners.push(listen("user_names/" + message.author, "value", function (authorSnapshot) {
									messageElem.text(message.timestamp + " - " + authorSnapshot.val() + ": " + message.content);
								}));
								
								scrollToBottom();
							};
							firebase.database().ref("chat_messages/" + chatId).orderByChild("timestamp").startAt(endTimestamp).on("child_added", messageCallback);
							chatListeners.push({path: "chat_messages/" + chatId, eventType: "child_added", callback: messageCallback});
						});
					}
				}
				
				function onLogout() {
					// Close chat
					closeChat();
				
					// Detach app listeners
					for (let appListener of appListeners)
						detach(appListener.path, appListener.eventType, appListener.callback);
					appListeners.length = 0;
				}
				
				firebase.auth().onAuthStateChanged(function (user) {
					$("#login-screen").toggle(user === null);
					$("#chat-screen").toggle(user !== null);
					
					if (user)
						verifyAccount(user);
					else
						onLogout();
				});
			});
		</script>
	</body>
</html>